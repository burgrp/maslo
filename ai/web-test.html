<html>

<head>
    <style>
        body {
            background-color: rgb(44, 46, 73);
            color: aliceblue;
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }

        #camera {
            width: 400px;
            height: 400px;
        }

        #frame {
            display: none;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <script>
        let module = {};
    </script>
    <script src="../controller/src/grid-reco.js"></script>

    <script>

        async function start() {

            let recognize = module.exports();

            let stream = await navigator.mediaDevices.getUserMedia({
                video: true
            });

            let cameraEl = document.getElementById("camera");
            cameraEl.srcObject = stream;
            let imageCapture = new ImageCapture(stream.getVideoTracks()[0]);

            let frameEl = document.getElementById("frame");
            let frameCanvas = frameEl.getContext("2d");

            let recoEl = document.getElementById("reco");
            let recoCanvas = recoEl.getContext("2d");

            while (true) {
                let frameBitmap = await imageCapture.grabFrame();

                frameEl.width = frameBitmap.width;
                frameEl.height = frameBitmap.height;

                frameCanvas.drawImage(frameBitmap, 0, 0, frameBitmap.width, frameBitmap.height);
                let frameData = frameCanvas.getImageData(0, 0, frameBitmap.width, frameBitmap.height);

                let size = Math.min(frameBitmap.width, frameBitmap.height);
                recoEl.width = size;
                recoEl.height = size;

                let bwData = new Uint8Array(new ArrayBuffer(size * size));
                let ofsX = (frameBitmap.width - size) / 2;
                let ofsY = (frameBitmap.height - size) / 2;
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        let i = 4 * (x + ofsX + frameData.width * (y + ofsY));
                        let v = Math.max(
                            frameData.data[i],
                            frameData.data[i + 1],
                            frameData.data[i + 2]
                        );
                        bwData[x + size * y] = 0xFF - v;
                    }
                }

                let result = recognize(bwData, size, true);
                document.getElementById("label").textContent = `${result.shape || ""}`;

                let recoData = new ImageData(size, size);
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        let v = bwData[x + size * y];
                        let i = 4 * (x + size * y);
                        recoData.data[i] = v;
                        recoData.data[i + 1] = v;
                        recoData.data[i + 2] = v;
                        recoData.data[i + 3] = 0xFF;
                    }
                }

                if (result.center) {
                    let center = {
                        x: Math.round(size * result.center.x),
                        y: Math.round(size * result.center.y)
                    };

                    for (let y = center.y - 3; y <= center.y + 3; y++) {
                        for (let x = center.x - 3; x <= center.x + 3; x++) {

                            let i = 4 * Math.floor(x + size * y);
                            recoData.data[i] = 0xFF;
                            recoData.data[i + 1] = 0;
                            recoData.data[i + 2] = 0;
                            recoData.data[i + 3] = 0xFF;
                        }
                    }
                }

                let recoBitmap = await createImageBitmap(recoData);
                recoCanvas.drawImage(recoBitmap, 0, 0, recoEl.width, recoEl.height);

                await new Promise(r => setTimeout(r, 10));
            }

        }
    </script>
</head>

<body onload="start().catch(e=>console.error(e))">

    <video autoplay id="camera"></video>
    <canvas id="frame"></canvas>
    <div id="label"></div>
    <canvas id="reco"></canvas>

</body>

</html>